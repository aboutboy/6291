#include "stdio.h"#include "string.h"#include "stdlib.h"#include "dirent.h"#include <wchar.h>#include <assert.h>#include <errno.h>#include <stdlib.h>             #include <ctype.h>#include <time.h>           #include <pwd.h>#include <grp.h>#include <unistd.h>#include <fcntl.h>#include <limits.h>      #include <setjmp.h>#include <netinet/in.h>#include <linux/wireless.h>#include <sys/ioctl.h>#include <sys/types.h>#include <sys/mman.h>#include <sys/types.h>        #include <sys/socket.h>      #include <sys/stat.h>         //#include "apmib.h"     #define watchdog_9331 1static char filePath[256]="/tmp/7221.s19";#define rtl_encryp_control "/proc/rtl_encryp_control"#define upload_bin_start  7#define get_power_level_num  1#define upload_bin_end  8#define WINIE6_STR	"/octet-stream\x0d\x0a\0x0d\0x0a"#define LINUXFX36_FWSTR "/x-ns-proxy-autoconfig\x0d\x0a\0x0d\0x0a"#define MACIE5_FWSTR	"/macbinary\x0d\x0a\0x0d\0x0a"#define OPERA_FWSTR	"/x-macbinary\x0d\x0a\0x0d\0x0a"#define GOOGLE_FWSTR	"/plain\x0d\x0a\0x0d\0x0a"#define LINE_FWSTR	"\x0d\x0a\0x0d\0x0a"#define CONF_HEADER                     ((char *)"conf")int find_head_offset(char *upload_data){	int head_offset=0 ;	char *pStart=NULL;	int iestr_offset=0;	char *dquote;	char *dquote1;		if (upload_data==NULL) {		//fprintf(stderr, "upload data is NULL\n");		return -1;	}	pStart = strstr(upload_data, WINIE6_STR);	if (pStart == NULL) {		pStart = strstr(upload_data, LINUXFX36_FWSTR);		if (pStart == NULL) {			pStart = strstr(upload_data, MACIE5_FWSTR);			if (pStart == NULL) {				pStart = strstr(upload_data, OPERA_FWSTR);				if (pStart == NULL) {					pStart = strstr(upload_data, GOOGLE_FWSTR);					if (pStart == NULL) {						pStart = strstr(upload_data, "filename=");						if (pStart == NULL) {							return -1;						}						else {							dquote =  strstr(pStart, "\"");							if (dquote !=NULL) {								dquote1 = strstr(dquote, LINE_FWSTR);								if (dquote1!=NULL) {									iestr_offset = 4;									pStart = dquote1;								}								else {									return -1;								}							}							else {								return -1;							}						}					}					else{						iestr_offset = 10;					}					}				else {					iestr_offset = 16;				}			} 			else {				iestr_offset = 14;			}		}		else {			iestr_offset = 26;		}	}	else {		iestr_offset = 17;	}	//fprintf(stderr,"####%s:%d %d###\n",  __FILE__, __LINE__ , iestr_offset);	head_offset = (int)(((unsigned long)pStart)-((unsigned long)upload_data)) + iestr_offset;//	printf("<br>head_offset=%d \n",head_offset);	return head_offset;}int main(){		FILE *fileBuf=NULL;		int head_offset=0 ;		char *upload_data=NULL;		int upload_len;		int i;		char errorBuf[200]="";		unsigned char linebuf[250];		int fh=NULL;		printf("Content-type: %s\r\n\r\n", "text/html");		fprintf(stdout,"<html><title>stm8 upgrade</title>\n");		fprintf(stdout,"<body>\n");		upload_len=atoi(getenv("CONTENT_LENGTH"));		upload_data=(char *)malloc(upload_len);		if(upload_data==NULL){			printf("STM8 upgrade  error\n");			goto error;		}		fread(upload_data,1,upload_len,stdin);		//printf("********************************\n");		//printf("len=%d\n",upload_len);		unsigned char isValidfw = 0;		head_offset = find_head_offset(upload_data);		if(head_offset == -1) {			printf("head_offset  error\n");			goto error;		}		//sleep(1);		//system("ifconfig br0 down 2> /dev/null");		fileBuf = fopen(filePath, "w");		if(fileBuf== NULL)		{				printf("fileBuf  null fjsafkasjlk\n");				goto error;		}//		printf("%s \n",(upload_data+head_offset));		fwrite((upload_data+head_offset),(upload_len-head_offset),1, fileBuf);		fclose(fileBuf);#ifdef watchdog_9331system("killall watchdog");#endif				fh=open(rtl_encryp_control, O_RDWR);		fileBuf = fopen(filePath, "rb");		if ((fileBuf== NULL)||(fh==NULL))		{			if(fileBuf== NULL)			{				printf("fileBuf  null fjsafkasjlk\n");			}			if(fh== NULL)			{				printf("fh null .\n");			}						goto error;		}		while(fgets(linebuf,250,fileBuf))		{		if(ioctl(fh, upload_bin_start, linebuf) < 0)			{				printf("upload_bin_start error \n\n");				goto error;			}			}		fclose(fileBuf);	if(ioctl(fh, upload_bin_end, 0) < 0)	{			printf("upload_bin_end error \n\n");	}		close(fh);	printf("<br>stm8 upgrade successful :)<br>");	fprintf(stdout,"</body>\n");	fprintf(stdout,"\n</html>\n");	return 0;error:	printf("<br>stm8 upgrade failed :(<br>");	fprintf(stdout,"</body>\n");	fprintf(stdout,"\n</html>\n");	return -1;	/*		unsigned char be;	while(1)	{		if(ioctl(fh, get_power_level_num, &be) < 0)		{			printf("get power error \n\n");		}			printf("be=%x \n",be);	}	*/}